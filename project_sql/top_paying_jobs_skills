WITH top_paying_jobs AS (
SELECT 
    job_postings_fact.job_id, -- add job_id to join with skills_job_dim table later
    job_title_short,
    company_dim.name AS company_name,
    salary_year_avg
FROM 
    job_postings_fact
    LEFT JOIN company_dim ON job_postings_fact.company_id = company_dim.company_id
WHERE 
    job_title_short = 'Data Analyst' 
    AND job_location = 'Singapore' 
    AND job_schedule_type = 'Full-time'
    AND salary_year_avg is not NULL
ORDER BY
    salary_year_avg DESC
LIMIT 10
) 

SELECT top_paying_jobs.job_id, --1
       top_paying_jobs.job_title_short, --2
       top_paying_jobs.salary_year_avg, --3
       top_paying_jobs.company_name, --4 
       ARRAY_AGG(skills_dim.skills ORDER BY skills_dim.skills) AS skills_array 
       -- aggregate skills into an array
FROM top_paying_jobs
INNER JOIN skills_job_dim ON top_paying_jobs.job_id = skills_job_dim.job_id
INNER JOIN skills_dim ON skills_job_dim.skill_id = skills_dim.skill_id
GROUP BY 1,2,3,4
ORDER BY
    salary_year_avg DESC;

/* This query retrieves the skills required for the top-paying 'Data Analyst' job 
postings in Singapore that are full-time. */